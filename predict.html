<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>RASALOKA - Prediksi</title>
    <link rel="stylesheet" href="{{ url_for('static', filename='predict.css') }}">
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css">
</head>
<body>
    <section class="main-container">
        <h1>RASALOKA</h1>
        <p class="subtitle">Arahkan kamera atau unggah gambar untuk prediksi makanan.</p>
        
        <!-- Camera Container -->
        <div class="camera-container" id="camera-container">
            <video id="video" autoplay playsinline class="camera-preview"></video>
            <canvas id="canvas" style="display: none;"></canvas>
            <button id="gallery-button" class="gallery-icon" title="Pilih dari Galeri">
                <i class="fas fa-image"></i>
            </button>
            <button id="predict-button" class="predict-now-button" title="Prediksi Sekarang">
                <i class="fas fa-camera"></i> Prediksi
            </button>
            <input type="file" id="file-input" accept=".jpg,.jpeg,.png" style="display: none;">
        </div>

        <!-- Action Buttons: Ganti & Hapus -->
        <div id="image-actions" style="display: none; text-align: center; margin-top: 15px; gap: 10px; justify-content: center;">
            <button id="replace-button" class="action-button replace-button">
                <i class="fas fa-sync-alt"></i> Ganti
            </button>
            <button id="delete-button" class="action-button delete-button">
                <i class="fas fa-trash"></i> Hapus
            </button>
        </div>

        <!-- Error Message -->
        {% if error %}
            <p class="error">{{ error }}</p>
        {% endif %}

        <!-- Prediction Result -->
        <div class="prediction-details" id="prediction-details" style="display: none; margin-top: 30px;">
            <div class="result-card">
                <p><strong>Nama Makanan:</strong> <span id="food-name">-</span></p>
                <p><strong>Asal Daerah:</strong> <span id="food-region">-</span></p>
                <p><strong>Tingkat Kepercayaan:</strong> <span id="food-confidence">-</span></p>
            </div>
        </div>
    </section>

    <script>
        const video = document.getElementById('video');
        const canvas = document.getElementById('canvas');
        const ctx = canvas.getContext('2d');
        const galleryButton = document.getElementById('gallery-button');
        const predictButton = document.getElementById('predict-button');
        const replaceButton = document.getElementById('replace-button');
        const deleteButton = document.getElementById('delete-button');
        const imageActions = document.getElementById('image-actions');
        const fileInput = document.getElementById('file-input');
        const cameraContainer = document.getElementById('camera-container');
        const predictionDetails = document.getElementById('prediction-details');
        const foodName = document.getElementById('food-name');
        const foodRegion = document.getElementById('food-region');
        const foodConfidence = document.getElementById('food-confidence');

        let currentImage = null; // Simpan elemen gambar aktif

        // Start camera
        async function startCamera() {
            try {
                const stream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                video.srcObject = stream;
                video.onloadedmetadata = () => {
                    video.play();
                    predictButton.disabled = false;
                };
            } catch (err) {
                console.error('Camera access failed:', err);
                alert('Kamera tidak dapat diakses. Gunakan galeri.');
                predictButton.style.display = 'none';
            }
        }

        // Capture frame dan prediksi
        async function captureAndPredict() {
            if (video.videoWidth === 0 || video.videoHeight === 0) return;

            canvas.width = video.videoWidth;
            canvas.height = video.videoHeight;
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            const imageData = canvas.toDataURL('image/jpeg', 0.8);

            predictButton.disabled = true;
            predictButton.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Memproses...';

            await sendPrediction(imageData);
            predictButton.disabled = false;
            predictButton.innerHTML = '<i class="fas fa-camera"></i> Prediksi';
        }

        // Kirim prediksi
        async function sendPrediction(imageData) {
            try {
                const response = await fetch('/predict', {
                    method: 'POST',
                    headers: { 'Content-Type': 'application/json' },
                    body: JSON.stringify({ image: imageData })
                });

                if (response.ok) {
                    const result = await response.json();
                    if (result.error) {
                        alert(result.error);
                        // Kembali ke mode kamera jika error
                        resetToCameraMode();
                        return;
                    }
                    foodName.textContent = result.name;
                    foodRegion.textContent = result.region;
                    foodConfidence.textContent = result.confidence;
                    predictionDetails.style.display = 'block';
                } else {
                    const errorData = await response.json();
                    alert(errorData.error || 'Gagal memproses prediksi.');
                    resetToCameraMode();
                }
            } catch (err) {
                alert('Gagal memproses prediksi.');
                resetToCameraMode();
            }
        }

        // Kembali ke mode kamera
        function resetToCameraMode() {
            // Hapus gambar
            if (currentImage) {
                currentImage.remove();
                currentImage = null;
            }

            // Sembunyikan tombol aksi
            imageActions.style.display = 'none';

            // Tampilkan elemen kamera
            video.style.display = 'block';
            predictButton.style.display = 'flex';
            galleryButton.style.display = 'block';

            // Reset hasil
            predictionDetails.style.display = 'none';

            // Mulai ulang kamera
            startCamera();
        }

        // Event: Prediksi Sekarang
        predictButton.addEventListener('click', captureAndPredict);

        // Event: Ganti Gambar
        replaceButton.addEventListener('click', () => {
            fileInput.click();
        });

        // Event: Hapus Gambar â†’ Kembali ke Kamera
        deleteButton.addEventListener('click', () => {
            if (confirm('Hapus gambar dan kembali ke kamera?')) {
                resetToCameraMode();
            }
        });

        // Event: Pilih dari Galeri
        galleryButton.addEventListener('click', () => {
            fileInput.click();
        });

        fileInput.addEventListener('change', async () => {
            if (fileInput.files.length === 0) return;

            const file = fileInput.files[0];
            const reader = new FileReader();
            reader.onload = async (e) => {
                const imageData = e.target.result;

                // Stop kamera
                video.srcObject?.getTracks().forEach(track => track.stop());
                video.style.display = 'none';
                predictButton.style.display = 'none';
                galleryButton.style.display = 'none';

                // Hapus gambar lama
                if (currentImage) currentImage.remove();

                // Tambah gambar baru
                const img = new Image();
                img.src = imageData;
                img.className = 'camera-preview';
                img.style.borderRadius = '12px';
                img.style.boxShadow = '0 6px 12px rgba(0,0,0,0.1)';
                cameraContainer.insertBefore(img, video);
                currentImage = img;

                // Tampilkan tombol aksi
                imageActions.style.display = 'flex';

                // Prediksi
                await sendPrediction(imageData);
            };
            reader.readAsDataURL(file);
        });

        // Start on load
        window.onload = () => {
            startCamera();
        };
        
    </script>
</body>
</html>